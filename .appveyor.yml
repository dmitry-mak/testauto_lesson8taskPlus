version: 1.0.{build}

# Триггеры
branches:
  only:
    - main

# Операционная система
image: Ubuntu2004

# Установка зависимостей
install:
  # Обновление пакетов и установка необходимых инструментов
  - sh: |
      sudo apt-get update
      sudo apt-get install -y openjdk-11-jdk docker.io docker-compose

  # Запуск Docker Compose для базы данных
  - name: Start database container
    sh: |
      sudo systemctl start docker
      docker-compose -f ./docker-compose.yml up -d
      sleep 30 # Ждём запуска контейнера

  # Выдача прав на gradlew
  - chmod +x gradlew

# Скрипт сборки
build_script:
  # Запуск SUT (системы под тестом)
  - sh: java -jar ./artifacts/app-deadline.jar &

  # Запуск тестов через Gradle
  - sh: ./gradlew test --info -Dselenide.headless=true

# Кэширование зависимостей
cache:
  - .gradle -> .gradle

# Отправка артефактов (если нужны)
artifacts:
  - path: build/reports/tests/test
    name: test-reports